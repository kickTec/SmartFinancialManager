<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" xmlns="http://www.w3.org/1999/html">
<head>
    <meta charset="UTF-8">
    <title th:utext="${detail.basic.fundName}+详情">详情</title>
    <script src="/echarts.min.js"></script>
    <script src="/jquery-3.3.1.min.js"></script>
    <style type="text/css">
        body{
            margin-left:30%;
        }
        .topClass{
        }
        .centerClass{
        }
        #nameTop {
            font-size: 1.5rem;
            font-weight: bold;
        }
        .horizontal{
            text-align:left;
            display:inline;
        }
    </style>
</head>
<body>
<div class="horizontal">
    <div id="topDiv" class="topClass horizontal">
        <p th:utext="${detail.basic.fundName}+'-'+${detail.basic.fundCode}" id="nameTop"></p>
        <input type="hidden" th:value="${detail.basic.fundCode}" id="fundCodeId" />
        <input type="hidden" th:value="${detail.basic.type}" id="typeId" />
    </div>
    <div id="centerDiv" class="centerClass horizontal">
        <div id="main" style="width: 600px;height:400px;"></div>
    </div>
</div>
<script type="text/javascript">
    // 基于准备好的dom，初始化echarts实例
    var myChart = echarts.init(document.getElementById('main'));

    // 指定图表的配置项和数据
    var option = {
        title: {
            text: 'ECharts 入门示例'
        },
        tooltip: {},
        legend: {
            data: ['销量']
        },
        xAxis: {
            data: ['衬衫', '羊毛衫', '雪纺衫', '裤子', '高跟鞋', '袜子']
        },
        yAxis: {},
        series: [
            {
                name: '销量',
                type: 'bar',
                data: [5, 20, 36, 10, 10, 20]
            }
        ]
    };

    // 设置chart选项
    function setChartOption(chart, title, xArray, yArray, startX) {
        var option = {
            title: {
                text: title,
                textStyle: {
                    align: 'center',
                    color: 'black',
                    fontSize: 13,
                },
                left: 'center'
            },

            // 折线图线条的颜色
            color: ["#37A2DA", "#67E0E3", "#9FE6B8"],

            // 刻度
            grid: {
                left: '1%',
                right: '3%',
                containLabel: true
            },

            // 悬浮图标
            tooltip: {
                show: true,
                trigger: 'axis',
                axisPointer: {
                    type: 'cross',
                    label: {
                        backgroundColor: '#6a7985'
                    }
                }
            },

            //x坐标轴
            xAxis: {
                type: 'category',
                //x坐标轴
                data: xArray,
                axisTick: {
                    show: false // 不显示坐标轴刻度线
                },
                axisLine: {
                    show: false, // 不显示坐标轴线
                },
                axisLabel: {
                    show: true, // 不显示坐标轴上的文字
                    interval: 'auto', // x轴间距
                    textStyle: {
                        color: '#000',
                        fontSize: '8'
                    },
                    formatter: function (params,index) {
                        // 根据展示数据量自定义间隔
                        var showNum = xArray.length * (1 - (startX / 100));
                        if (showNum > 40) {
                            if (index % 3 != 0) {
                                return '';
                            }
                        } else if (showNum > 20) {
                            if (index % 2 == 0) {
                                return '';
                            }
                        }

                        // x轴换行显示
                        params = params.replace(/-/g, '');
                        params = params.substring(4, params.length);
                        var newParamsName = "";
                        var paramsNameNumber = params.length;
                        var provideNumber = 2; //一行显示几个字
                        var rowNumber = Math.ceil(paramsNameNumber / provideNumber);
                        if (paramsNameNumber > provideNumber) {
                            for (var p = 0; p < rowNumber; p++) {
                                var tempStr = "";
                                var start = p * provideNumber;
                                var end = start + provideNumber;
                                if (p === (rowNumber - 1)) {
                                    tempStr = params.substring(start, paramsNameNumber);
                                } else {
                                    tempStr = params.substring(start, end) + "\n";
                                }
                                newParamsName += tempStr;
                            }
                        } else {
                            newParamsName = params;
                        }

                        return newParamsName;
                    }
                },
                splitLine: {
                    show: false // 不显示网格线
                }
            },

            //y坐标轴
            yAxis: {
                show: true,
                splitLine: {
                    lineStyle: {
                        type: 'dotted',//分割线变成虚线
                    }
                },
                axisLine: {
                    lineStyle: {
                        opacity: 0,
                    }
                },
                axisTick: {
                    show: false, // 不显示坐标轴刻度线
                },
                axisLine: {
                    show: false, // 不显示坐标轴线
                },
                axisLabel: {
                    show: true // 不显示坐标轴上的文字
                },
                min: function(value) {
                    return Math.floor(value.min)
                },
                max: function(value) {
                    return Math.ceil(value.max)
                }
        },

        dataZoom: [
            {
                show: true,
                type: 'inside',
                start: startX,
                end: 100
            }
        ],
            series: [{
            name: '股价',
            type: 'line',
            // 设置折线是否平滑
            smooth: false,
            showAllSymbol: true,
            symbolSize: 1,
            lineStyle: {
                normal: {
                    color: "#2B68D4", // 线条颜色
                },
            },
            //对应x轴的y轴数据
            data: yArray,
            markPoint: {
                data: [
                    { type: 'max', name: '最大值' },
                    { type: 'min', name: '最小值' }
                ]
            },
            markLine: {
                label: {
                    position: "middle", //将警示值放在哪个位置，三个值“start”,"middle","end"  开始  中点 结束
                },
                data: [
                    { type: 'average', name: '平均值' }
                ]
            }
        }]
    };
        chart.clear();
        chart.setOption(option);
    }

    function initEcharts(chart, name, dayNum, xArrayTop, yArrayTop) {
        var start = 0;
        if (dayNum < xArrayTop.length){
            start = (1 - (dayNum / xArrayTop.length)) * 100;
            console.log("xArrayTop.length:"+xArrayTop.length+",start:"+start);
            start = fixStart(xArrayTop.length, dayNum, start);
            console.log("修复后start:"+start);
        }
        setChartOption(chart, name, xArrayTop, yArrayTop, start);
    }

    function fixStart(total, dayNum, start) {
        for(var i=0; i<50; i++){
            var startPer = start/100;
            startPer = Math.round(startPer*1000)/1000;
            console.log("start:"+start+",startPer:"+startPer);
            if(total*startPer < total-dayNum){
                start = startPer*100 + 0.1;
            }else{
                break;
            }
        }
        return start;
    }

    function queryDetail() {
        var fundCode = $("#fundCodeId").val();
        var type = $("#typeId").val();
        var url = '/fund/queryDetail';
        var dataValue ={};
        dataValue.fundCode=fundCode;
        dataValue.fundType=type;
        var dataParam  = {};
        dataParam.data = dataValue;
        dataParam.data = JSON.stringify(dataValue);

        $.ajax({
            type: "POST",
            url: url,
            data: dataParam,
            contentType: "application/x-www-form-urlencoded",
            success: function(res){
                console.log(res);
                var response = JSON.parse(res);
                if (response !== null && response.flag === true) {
                    var xArray = response.data.lastData90.dateList;
                    var yArray = response.data.lastData90.stockValueList;
                    if (xArray == undefined || xArray == null){
                        xArray = [];
                    }
                    if (yArray == undefined || yArray == null) {
                        yArray = [];
                    }
                    var intervalDefault = 0.5
                    if (response.data.basic.curNetValue > 100){
                        intervalDefault = 0.5 + ((response.data.basic.curNetValue - 100) / 10) * 0.1;
                    }else{
                        intervalDefault = 0.2 + (response.data.basic.curNetValue/ 10) * 0.1;
                    }

                    // intervalDefault = util.setScale(intervalDefault, 2);
                    var gridQuantity = 100;
                    if (response.data.basic.fundName.indexOf("转债") > 0){
                        gridQuantity = 10;
                    }
                    initEcharts(myChart, "15日走势图", 15, xArray, yArray);
                } else {
                    alert('服务器连接异常!');
                }
            }
        });
    }

    queryDetail();

    // 测试
    /*
    var xArray = ['1', '2', '3', '4', '5', '6'];
    var xArray = [5, 20, 36, 10, 10, 20];
    setChartOption(myChart, '测试', xArray, xArray, 0);*/

</script>
</body>
</html>
